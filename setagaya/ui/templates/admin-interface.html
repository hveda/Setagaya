<!DOCTYPE html>
<html>
<head>
    <title>Setagaya Admin Interface - Phase 3</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <link href="/static/css/styles.css" rel="stylesheet">
    <link href="/static/fontawesome/css/all.min.css" rel="stylesheet">
    
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Axios for HTTP requests -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    
    <script>
        // Simple permission check for demo purposes
        // In production, this would integrate with your RBAC system
        document.addEventListener('alpine:init', () => {
            Alpine.directive('show-if-permission', (el, { expression }, { evaluate }) => {
                const permission = evaluate(expression);
                // For demo purposes, show all admin elements
                // In production: check actual user permissions
                if (!checkPermission(permission)) {
                    el.style.display = 'none';
                }
            });
        });

        function checkPermission(permission) {
            // Simple demo permission check
            // In production, this would check against the user's actual permissions
            return true; // Allow all for demo
        }
    </script>
    
    <style>
        .admin-sidebar {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            min-height: calc(100vh - 80px);
        }
        
        .admin-nav-item {
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }
        
        .admin-nav-item:hover, .admin-nav-item.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
            text-decoration: none;
        }
        
        .admin-card {
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .admin-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        
        .metric-card {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }
        
        .file-drop-zone {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            transition: all 0.3s ease;
            background: #f8f9fa;
            min-height: 200px;
        }
        
        .file-drop-zone.drag-over {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .progress-circle {
            width: 40px;
            height: 40px;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        /* Enhanced navigation styles */
        .breadcrumb {
            font-size: 0.875rem;
        }
        
        .breadcrumb-item + .breadcrumb-item::before {
            content: ">";
            color: #6c757d;
        }
        
        .breadcrumb-item a:hover {
            text-decoration: none;
            color: #fff !important;
        }
        
        .btn-outline-light.active {
            background-color: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .navbar .status-indicator {
            width: 8px;
            height: 8px;
        }
        
        /* Alpine.js cloak to prevent flash of content */
        [x-cloak] { 
            display: none !important; 
        }
    </style>
</head>

<body x-data="adminInterface()" x-init="init()" x-cloak>
    <!-- Navigation Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <!-- Left side: Brand and navigation -->
            <div class="navbar-nav mr-auto d-flex flex-row">
                <a class="navbar-brand mr-4" href="/">
                    <i class="fas fa-arrow-left mr-2"></i>
                    <span class="d-none d-md-inline">Back to Setagaya</span>
                </a>
                
                <a class="navbar-brand" href="#admin">
                    <i class="fas fa-shield-alt mr-2"></i>
                    Admin Panel
                </a>
                
                <!-- Breadcrumb -->
                <nav aria-label="breadcrumb" class="d-none d-lg-block ml-4">
                    <ol class="breadcrumb bg-transparent mb-0 p-0">
                        <li class="breadcrumb-item">
                            <a href="/" class="text-light">
                                <i class="fas fa-home mr-1"></i>Home
                            </a>
                        </li>
                        <li class="breadcrumb-item">
                            <a href="#admin" class="text-light">Admin</a>
                        </li>
                        <li class="breadcrumb-item active text-warning" aria-current="page" 
                            x-text="activeTab.charAt(0).toUpperCase() + activeTab.slice(1)">
                            Dashboard
                        </li>
                    </ol>
                </nav>
            </div>
            
            <!-- Center: Quick Actions -->
            <div class="navbar-nav mx-auto d-none d-xl-flex flex-row">
                <button class="btn btn-outline-light btn-sm mx-1" 
                        @click="setActiveTab('dashboard')" 
                        :class="{ 'active': activeTab === 'dashboard' }">
                    <i class="fas fa-tachometer-alt mr-1"></i>Dashboard
                </button>
                <button class="btn btn-outline-light btn-sm mx-1" 
                        @click="setActiveTab('users')" 
                        :class="{ 'active': activeTab === 'users' }"
                        x-show-if-permission="users:read">
                    <i class="fas fa-users mr-1"></i>Users
                </button>
                <button class="btn btn-outline-light btn-sm mx-1" 
                        @click="setActiveTab('monitoring')" 
                        :class="{ 'active': activeTab === 'monitoring' }">
                    <i class="fas fa-chart-line mr-1"></i>Monitor
                </button>
            </div>
            
            <!-- Right side: System status and user menu -->
            <div class="navbar-nav ml-auto d-flex flex-row align-items-center">
                <!-- System Status Indicator -->
                <div class="nav-item mr-3 d-none d-md-block">
                    <span class="badge" :class="systemStatus.isOnline ? 'badge-success' : 'badge-danger'">
                        <span class="status-indicator" 
                              :class="systemStatus.isOnline ? 'status-online' : 'status-offline'"></span>
                        <span x-text="systemStatus.isOnline ? 'System Online' : 'System Offline'"></span>
                    </span>
                </div>
                
                <!-- Current Time -->
                <div class="nav-item mr-3 d-none d-lg-block">
                    <small class="text-light" x-text="currentTime">
                        Loading...
                    </small>
                </div>
                
                <!-- User Dropdown -->
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" 
                       role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        <div class="user-avatar mr-2">
                            <span x-text="(currentUser?.username || 'A').charAt(0).toUpperCase()"></span>
                        </div>
                        <div class="d-none d-md-block">
                            <div class="text-light" x-text="currentUser?.username || 'Admin'"></div>
                            <small class="text-muted" x-text="currentUser?.roles?.[0]?.name || 'Administrator'"></small>
                        </div>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right">
                        <div class="dropdown-header">
                            <strong x-text="currentUser?.username || 'Admin'"></strong>
                            <br>
                            <small class="text-muted" x-text="currentUser?.email || 'admin@setagaya.local'"></small>
                        </div>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="/">
                            <i class="fas fa-home mr-2"></i>Main Application
                        </a>
                        <a class="dropdown-item" href="/api/">
                            <i class="fas fa-code mr-2"></i>API Documentation
                        </a>
                        <a class="dropdown-item" href="http://localhost:3000" target="_blank">
                            <i class="fas fa-chart-bar mr-2"></i>Grafana Dashboard
                        </a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#" @click="logout()">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar Navigation -->
            <div class="col-md-3 col-lg-2 px-0">
                <div class="admin-sidebar p-3">
                    <nav class="nav flex-column">
                        <a class="nav-link admin-nav-item mb-2 p-3 rounded" 
                           :class="{ 'active': activeTab === 'dashboard' }"
                           @click="setActiveTab('dashboard')" href="#">
                            <i class="fas fa-tachometer-alt mr-2"></i>
                            Dashboard
                        </a>
                        
                        <a class="nav-link admin-nav-item mb-2 p-3 rounded"
                           :class="{ 'active': activeTab === 'users' }"
                           @click="setActiveTab('users')" href="#"
                           x-show-if-permission="users:read">
                            <i class="fas fa-users mr-2"></i>
                            User Management
                        </a>
                        
                        <a class="nav-link admin-nav-item mb-2 p-3 rounded"
                           :class="{ 'active': activeTab === 'roles' }"
                           @click="setActiveTab('roles')" href="#"
                           x-show-if-permission="roles:read">
                            <i class="fas fa-user-shield mr-2"></i>
                            Role Management
                        </a>
                        
                        <a class="nav-link admin-nav-item mb-2 p-3 rounded"
                           :class="{ 'active': activeTab === 'collections' }"
                           @click="setActiveTab('collections')" href="#"
                           x-show-if-permission="collections:read_all">
                            <i class="fas fa-tasks mr-2"></i>
                            Collection Monitor
                        </a>
                        
                        <a class="nav-link admin-nav-item mb-2 p-3 rounded"
                           :class="{ 'active': activeTab === 'files' }"
                           @click="setActiveTab('files')" href="#"
                           x-show-if-permission="files:read">
                            <i class="fas fa-folder mr-2"></i>
                            File Management
                        </a>
                        
                        <a class="nav-link admin-nav-item mb-2 p-3 rounded"
                           :class="{ 'active': activeTab === 'monitoring' }"
                           @click="setActiveTab('monitoring')" href="#"
                           x-show-if-permission="monitoring:read_all">
                            <i class="fas fa-chart-line mr-2"></i>
                            System Monitoring
                        </a>
                        
                        <a class="nav-link admin-nav-item mb-2 p-3 rounded"
                           href="/docs" target="_blank">
                            <i class="fas fa-book mr-2"></i>
                            API Documentation
                        </a>
                    </nav>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="col-md-9 col-lg-10">
                <div class="p-4">
                    <!-- Dashboard Tab -->
                    <div x-show="activeTab === 'dashboard'" x-data="adminDashboard()" x-init="init()">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="h3 mb-0">Admin Dashboard</h2>
                            <div class="text-muted">
                                <span class="status-indicator" :class="systemStatus.isOnline ? 'status-online' : 'status-offline'"></span>
                                System <span x-text="systemStatus.isOnline ? 'Online' : 'Offline'"></span>
                            </div>
                        </div>

                        <!-- System Overview Cards -->
                        <div class="row mb-4">
                            <div class="col-md-3 mb-3">
                                <div class="card admin-card metric-card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-users fa-2x mb-2"></i>
                                        <h4 class="mb-0" x-text="stats.totalUsers || 0"></h4>
                                        <small>Total Users</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <div class="card admin-card metric-card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-project-diagram fa-2x mb-2"></i>
                                        <h4 class="mb-0" x-text="stats.totalProjects || 0"></h4>
                                        <small>Total Projects</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <div class="card admin-card metric-card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-clipboard-list fa-2x mb-2"></i>
                                        <h4 class="mb-0" x-text="stats.totalPlans || 0"></h4>
                                        <small>Total Plans</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <div class="card admin-card metric-card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-play-circle fa-2x mb-2"></i>
                                        <h4 class="mb-0" x-text="stats.activeCollections || 0"></h4>
                                        <small>Active Collections</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- System Health Metrics -->
                        <div class="row mb-4">
                            <div class="col-md-3 mb-3">
                                <div class="card admin-card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-microchip fa-2x mb-2 text-primary"></i>
                                        <h4 class="mb-0" x-text="systemHealth.cpu + '%' || '0%'"></h4>
                                        <small>CPU Usage</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <div class="card admin-card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-memory fa-2x mb-2 text-warning"></i>
                                        <h4 class="mb-0" x-text="systemHealth.memory + '%' || '0%'"></h4>
                                        <small>Memory Usage</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <div class="card admin-card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-hdd fa-2x mb-2 text-info"></i>
                                        <h4 class="mb-0" x-text="systemHealth.disk + '%' || '0%'"></h4>
                                        <small>Disk Usage</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-3 mb-3">
                                <div class="card admin-card text-center">
                                    <div class="card-body">
                                        <i class="fas fa-heartbeat fa-2x mb-2" :class="systemStatus.isOnline ? 'text-success' : 'text-danger'"></i>
                                        <h4 class="mb-0" x-text="systemStatus.isOnline ? 'Online' : 'Offline'"></h4>
                                        <small>System Status</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="row">
                            <div class="col-lg-8">
                                <div class="card admin-card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Recent Activity</h5>
                                    </div>
                                    <div class="card-body">
                                        <div x-show="recentActivity.length === 0" class="text-center text-muted py-4">
                                            No recent activity
                                        </div>
                                        
                                        <template x-for="activity in recentActivity" :key="activity.id">
                                            <div class="d-flex align-items-start mb-3 pb-3 border-bottom">
                                                <div class="user-avatar mr-3">
                                                    <span x-text="activity.user?.charAt(0).toUpperCase()"></span>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <div class="d-flex justify-content-between">
                                                        <strong x-text="activity.user"></strong>
                                                        <small class="text-muted" x-text="formatTime(activity.timestamp)"></small>
                                                    </div>
                                                    <div x-text="activity.action"></div>
                                                    <small class="text-muted" x-text="activity.details"></small>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-lg-4">
                                <div class="card admin-card">
                                    <div class="card-header">
                                        <h5 class="mb-0">System Health</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between">
                                                <span>CPU Usage</span>
                                                <span x-text="systemHealth.cpu || '0%'"></span>
                                            </div>
                                            <div class="progress">
                                                <div class="progress-bar" role="progressbar" 
                                                     :style="`width: ${systemHealth.cpu || 0}%`"></div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between">
                                                <span>Memory Usage</span>
                                                <span x-text="systemHealth.memory || '0%'"></span>
                                            </div>
                                            <div class="progress">
                                                <div class="progress-bar bg-warning" role="progressbar" 
                                                     :style="`width: ${systemHealth.memory || 0}%`"></div>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between">
                                                <span>Disk Usage</span>
                                                <span x-text="systemHealth.disk || '0%'"></span>
                                            </div>
                                            <div class="progress">
                                                <div class="progress-bar bg-info" role="progressbar" 
                                                     :style="`width: ${systemHealth.disk || 0}%`"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- User Management Tab -->
                    <div x-show="activeTab === 'users'" x-data="userManagementComponent()" x-init="init()">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="h3 mb-0">User Management</h2>
                            <button class="btn btn-primary" @click="showUserModal = true" 
                                    x-show-if-permission="users:create">
                                <i class="fas fa-plus mr-2"></i>Add User
                            </button>
                        </div>

                        <!-- Search and Filter -->
                        <div class="card admin-card mb-4">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" placeholder="Search users..." 
                                               x-model="searchTerm">
                                    </div>
                                    <div class="col-md-6">
                                        <select class="form-control">
                                            <option value="">All Roles</option>
                                            <template x-for="role in roles" :key="role.id">
                                                <option :value="role.id" x-text="role.name"></option>
                                            </template>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Users Table -->
                        <div class="card admin-card">
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>User</th>
                                                <th>Email</th>
                                                <th>Roles</th>
                                                <th>Status</th>
                                                <th>Last Login</th>
                                                <th x-show-if-permission="users:update">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template x-for="user in filteredUsers" :key="user.id">
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="user-avatar mr-2">
                                                                <span x-text="user.username?.charAt(0).toUpperCase()"></span>
                                                            </div>
                                                            <div>
                                                                <div x-text="user.full_name || user.username"></div>
                                                                <small class="text-muted" x-text="user.username"></small>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td x-text="user.email"></td>
                                                    <td>
                                                        <template x-for="role in user.roles" :key="role.id">
                                                            <span class="badge badge-secondary mr-1" x-text="role.name"></span>
                                                        </template>
                                                    </td>
                                                    <td>
                                                        <span class="badge" 
                                                              :class="user.active ? 'badge-success' : 'badge-secondary'"
                                                              x-text="user.active ? 'Active' : 'Inactive'"></span>
                                                    </td>
                                                    <td x-text="formatDate(user.last_login)"></td>
                                                    <td x-show-if-permission="users:update">
                                                        <div class="btn-group">
                                                            <button class="btn btn-sm btn-outline-primary" 
                                                                    @click="selectUser(user)">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                            <button class="btn btn-sm btn-outline-danger" 
                                                                    @click="deleteUser(user)" 
                                                                    x-show-if-permission="users:delete">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- File Management Tab -->
                    <div x-show="activeTab === 'files'">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="h3 mb-0">File Management</h2>
                        </div>

                        <!-- File Upload Area -->
                        <div class="card admin-card mb-4" x-data="fileUploadComponent()" x-init="init()">
                            <div class="card-header">
                                <h5 class="mb-0">Upload Files</h5>
                            </div>
                            <div class="card-body">
                                <div class="file-drop-zone d-flex flex-column align-items-center justify-content-center p-4"
                                     :class="{ 'drag-over': isDragOver }" 
                                     @dragover.prevent="isDragOver = true"
                                     @dragleave.prevent="isDragOver = false"
                                     @drop.prevent="isDragOver = false; handleFiles($event.dataTransfer.files)">
                                    
                                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                    <h4 class="text-muted">Drag & Drop Files Here</h4>
                                    <p class="text-muted">or click to browse</p>
                                    <input type="file" class="d-none" multiple 
                                           @change="handleFiles($event.target.files)"
                                           accept=".jmx,.jar,.csv,.properties,.txt">
                                    <button class="btn btn-outline-primary" @click="$el.previousElementSibling.click()">
                                        Browse Files
                                    </button>
                                </div>

                                <!-- Upload Queue -->
                                <div x-show="files.length > 0" class="mt-4">
                                    <h6>Upload Queue</h6>
                                    <template x-for="file in files" :key="file.id">
                                        <div class="d-flex align-items-center justify-content-between border-bottom py-2">
                                            <div class="d-flex align-items-center">
                                                <i :class="getFileIcon(file.name)" class="mr-2"></i>
                                                <div>
                                                    <div x-text="file.name"></div>
                                                    <small class="text-muted" x-text="formatFileSize(file.size)"></small>
                                                </div>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <div class="progress mr-3" style="width: 100px;">
                                                    <div class="progress-bar" role="progressbar" 
                                                         :style="`width: ${file.progress}%`"></div>
                                                </div>
                                                <i :class="getStatusIcon(file.status)"></i>
                                                <button class="btn btn-sm btn-outline-danger ml-2" 
                                                        @click="removeFile(file.id)">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </template>
                                    
                                    <div class="mt-3">
                                        <button class="btn btn-primary mr-2" @click="uploadFiles()" 
                                                :disabled="isUploading" x-show-if-permission="files:upload">
                                            <i class="fas fa-upload mr-2"></i>Upload All
                                        </button>
                                        <button class="btn btn-outline-secondary" @click="clearAll()">
                                            Clear All
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- File Browser -->
                        <div class="card admin-card" x-data="fileManagerComponent()" x-init="init()">
                            <div class="card-header">
                                <h5 class="mb-0">File Browser</h5>
                            </div>
                            <div class="card-body">
                                <!-- Search and Controls -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <input type="text" class="form-control" placeholder="Search files..." 
                                               x-model="searchTerm">
                                    </div>
                                    <div class="col-md-6 text-right">
                                        <button class="btn btn-outline-danger" @click="deleteSelectedFiles()"
                                                x-show="selectedFiles.size > 0" x-show-if-permission="files:delete">
                                            <i class="fas fa-trash mr-2"></i>Delete Selected
                                        </button>
                                    </div>
                                </div>

                                <!-- Files Table -->
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>
                                                    <input type="checkbox" @change="$event.target.checked ? selectAllFiles() : clearSelection()">
                                                </th>
                                                <th @click="setSorting('name')" style="cursor: pointer;">
                                                    Name
                                                    <i class="fas fa-sort ml-1"></i>
                                                </th>
                                                <th @click="setSorting('size')" style="cursor: pointer;">
                                                    Size
                                                    <i class="fas fa-sort ml-1"></i>
                                                </th>
                                                <th @click="setSorting('uploaded_at')" style="cursor: pointer;">
                                                    Uploaded
                                                    <i class="fas fa-sort ml-1"></i>
                                                </th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <template x-for="file in paginatedFiles" :key="file.id">
                                                <tr>
                                                    <td>
                                                        <input type="checkbox" 
                                                               :checked="selectedFiles.has(file.id)"
                                                               @change="toggleFileSelection(file.id)">
                                                    </td>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <i :class="getFileIcon(file.name)" class="mr-2"></i>
                                                            <span x-text="file.name"></span>
                                                        </div>
                                                    </td>
                                                    <td x-text="formatFileSize(file.size)"></td>
                                                    <td x-text="formatDate(file.uploaded_at)"></td>
                                                    <td>
                                                        <div class="btn-group">
                                                            <button class="btn btn-sm btn-outline-primary" 
                                                                    @click="downloadFile(file.id, file.name)"
                                                                    x-show-if-permission="files:download">
                                                                <i class="fas fa-download"></i>
                                                            </button>
                                                            <button class="btn btn-sm btn-outline-danger" 
                                                                    @click="deleteFile(file.id)"
                                                                    x-show-if-permission="files:delete">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </template>
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Pagination -->
                                <nav x-show="totalPages > 1">
                                    <ul class="pagination justify-content-center">
                                        <li class="page-item" :class="{ 'disabled': currentPage === 1 }">
                                            <a class="page-link" @click="currentPage = Math.max(1, currentPage - 1)">Previous</a>
                                        </li>
                                        <template x-for="page in totalPages" :key="page">
                                            <li class="page-item" :class="{ 'active': currentPage === page }">
                                                <a class="page-link" @click="currentPage = page" x-text="page"></a>
                                            </li>
                                        </template>
                                        <li class="page-item" :class="{ 'disabled': currentPage === totalPages }">
                                            <a class="page-link" @click="currentPage = Math.min(totalPages, currentPage + 1)">Next</a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>

                    <!-- System Monitoring Tab -->
                    <div x-show="activeTab === 'monitoring'" x-data="realtimeSystemComponent()" x-init="init()">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h2 class="h3 mb-0">System Monitoring</h2>
                            <div class="text-muted">
                                <span class="status-indicator" :class="isConnected ? 'status-online' : 'status-offline'"></span>
                                Real-time <span x-text="isConnected ? 'Connected' : 'Disconnected'"></span>
                            </div>
                        </div>

                        <!-- Real-time Metrics -->
                        <div class="row mb-4">
                            <div class="col-lg-12">
                                <div class="card admin-card">
                                    <div class="card-header">
                                        <h5 class="mb-0">Live System Metrics</h5>
                                        <small class="text-muted">Last updated: <span x-text="formatTime(lastUpdate)"></span></small>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3 text-center">
                                                <div class="metric-card p-3 rounded">
                                                    <h4 x-text="systemMetrics.activeConnections || 0"></h4>
                                                    <small>Active Connections</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3 text-center">
                                                <div class="metric-card p-3 rounded">
                                                    <h4 x-text="systemMetrics.requestsPerSecond || 0"></h4>
                                                    <small>Requests/sec</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3 text-center">
                                                <div class="metric-card p-3 rounded">
                                                    <h4 x-text="systemMetrics.responseTime || '0ms'"></h4>
                                                    <small>Avg Response Time</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3 text-center">
                                                <div class="metric-card p-3 rounded">
                                                    <h4 x-text="systemMetrics.errorRate || '0%'"></h4>
                                                    <small>Error Rate</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load JavaScript Components -->
    <script src="/static/js/auth.js"></script>
    <script src="/static/js/rbac-components.js"></script>
    <script src="/static/js/admin.js"></script>
    <script src="/static/js/file-upload.js"></script>
    <script src="/static/js/realtime.js"></script>
    
    <script>
        // Admin Interface Main Component
        function adminInterface() {
            return {
                activeTab: 'dashboard',
                currentUser: null,
                currentTime: '',
                systemStatus: { isOnline: true },

                async init() {
                    try {
                        const response = await axios.get('/api/rbac/me');
                        this.currentUser = response.data.user;
                    } catch (error) {
                        console.error('Failed to load user info:', error);
                    }
                    
                    // Initialize current time
                    this.updateTime();
                    setInterval(() => this.updateTime(), 1000);
                    
                    console.log('Admin interface initialized');
                },

                setActiveTab(tab) {
                    this.activeTab = tab;
                },

                updateTime() {
                    const now = new Date();
                    this.currentTime = now.toLocaleTimeString();
                },

                logout() {
                    if (confirm('Are you sure you want to logout?')) {
                        // Send POST request to logout endpoint
                        axios.post('/logout')
                            .then(() => {
                                window.location.href = '/login';
                            })
                            .catch((error) => {
                                console.error('Logout error:', error);
                                // Force redirect to login page even if logout fails
                                window.location.href = '/login';
                            });
                    }
                }
            }
        }

        // Admin Dashboard Component
        function adminDashboard() {
            return {
                stats: {},
                recentActivity: [],
                systemHealth: {},
                systemStatus: { isOnline: true },

                async init() {
                    await this.loadStats();
                    await this.loadRecentActivity();
                    await this.loadSystemHealth();
                    
                    // Set up real-time updates
                    setInterval(() => this.loadSystemHealth(), 30000);
                },

                async loadStats() {
                    try {
                        const response = await axios.get('/api/admin/stats');
                        this.stats = response.data;
                    } catch (error) {
                        console.error('Failed to load stats:', error);
                    }
                },

                async loadRecentActivity() {
                    try {
                        const response = await axios.get('/api/admin/activity');
                        this.recentActivity = response.data.activities || [];
                    } catch (error) {
                        console.error('Failed to load recent activity:', error);
                    }
                },

                async loadSystemHealth() {
                    try {
                        const response = await axios.get('/api/admin/health');
                        this.systemHealth = response.data;
                        this.systemStatus.isOnline = true;
                    } catch (error) {
                        console.error('Failed to load system health:', error);
                        this.systemStatus.isOnline = false;
                    }
                },

                formatTime(timestamp) {
                    return timestamp ? new Date(timestamp).toLocaleString() : 'Never';
                },

                formatDate(dateString) {
                    return dateString ? new Date(dateString).toLocaleDateString() : 'Never';
                }
            }
        }

        // User Management Component
        function userManagementComponent() {
            return {
                users: [],
                roles: [],
                selectedUser: null,
                showUserModal: false,
                searchTerm: '',
                loading: false,

                async init() {
                    await this.loadUsers();
                    await this.loadRoles();
                },

                async loadUsers() {
                    try {
                        this.loading = true;
                        const response = await axios.get('/api/rbac/users');
                        this.users = response.data.users || [];
                    } catch (error) {
                        console.error('Failed to load users:', error);
                        this.users = [];
                    } finally {
                        this.loading = false;
                    }
                },

                async loadRoles() {
                    try {
                        const response = await axios.get('/api/rbac/roles');
                        this.roles = response.data.roles || [];
                    } catch (error) {
                        console.error('Failed to load roles:', error);
                        this.roles = [];
                    }
                },

                get filteredUsers() {
                    if (!this.searchTerm) return this.users;
                    return this.users.filter(user => 
                        user.username?.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
                        user.full_name?.toLowerCase().includes(this.searchTerm.toLowerCase()) ||
                        user.email?.toLowerCase().includes(this.searchTerm.toLowerCase())
                    );
                },

                selectUser(user) {
                    this.selectedUser = { ...user };
                    this.showUserModal = true;
                },

                async deleteUser(user) {
                    if (!confirm(`Are you sure you want to delete user ${user.username}?`)) {
                        return;
                    }

                    try {
                        await axios.delete(`/api/rbac/users/${user.id}`);
                        await this.loadUsers();
                    } catch (error) {
                        console.error('Failed to delete user:', error);
                        alert('Failed to delete user');
                    }
                },

                formatDate(dateString) {
                    return dateString ? new Date(dateString).toLocaleDateString() : 'Never';
                }
            }
        }

        // File Upload Component
        function fileUploadComponent() {
            return {
                files: [],
                isDragOver: false,
                isUploading: false,

                init() {
                    console.log('File upload component initialized');
                },

                handleFiles(fileList) {
                    Array.from(fileList).forEach(file => {
                        this.files.push({
                            id: Date.now() + Math.random(),
                            name: file.name,
                            size: file.size,
                            file: file,
                            progress: 0,
                            status: 'pending'
                        });
                    });
                },

                removeFile(fileId) {
                    this.files = this.files.filter(f => f.id !== fileId);
                },

                clearAll() {
                    this.files = [];
                },

                async uploadFiles() {
                    this.isUploading = true;
                    
                    for (let fileItem of this.files) {
                        if (fileItem.status === 'completed') continue;
                        
                        const formData = new FormData();
                        formData.append('file', fileItem.file);
                        
                        try {
                            fileItem.status = 'uploading';
                            const response = await axios.post('/api/admin/files/upload', formData, {
                                headers: {
                                    'Content-Type': 'multipart/form-data',
                                },
                                onUploadProgress: (progressEvent) => {
                                    fileItem.progress = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                                }
                            });
                            fileItem.status = 'completed';
                        } catch (error) {
                            console.error('Upload failed:', error);
                            fileItem.status = 'error';
                        }
                    }
                    
                    this.isUploading = false;
                },

                getFileIcon(filename) {
                    const ext = filename.split('.').pop().toLowerCase();
                    const iconMap = {
                        'jmx': 'fas fa-cogs',
                        'jar': 'fas fa-file-archive',
                        'csv': 'fas fa-file-csv',
                        'txt': 'fas fa-file-alt',
                        'properties': 'fas fa-file-code'
                    };
                    return iconMap[ext] || 'fas fa-file';
                },

                getStatusIcon(status) {
                    const statusMap = {
                        'pending': 'fas fa-clock text-warning',
                        'uploading': 'fas fa-spinner fa-spin text-primary',
                        'completed': 'fas fa-check text-success',
                        'error': 'fas fa-times text-danger'
                    };
                    return statusMap[status] || 'fas fa-question';
                },

                formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                }
            }
        }

        // File Manager Component
        function fileManagerComponent() {
            return {
                files: [],
                selectedFiles: new Set(),
                searchTerm: '',
                sortBy: 'name',
                sortDesc: false,
                currentPage: 1,
                pageSize: 10,

                async init() {
                    await this.loadFiles();
                },

                async loadFiles() {
                    try {
                        const response = await axios.get('/api/admin/files');
                        this.files = response.data.files || [];
                    } catch (error) {
                        console.error('Failed to load files:', error);
                        this.files = [];
                    }
                },

                get filteredFiles() {
                    let filtered = this.files;
                    
                    if (this.searchTerm) {
                        filtered = filtered.filter(file => 
                            file.name.toLowerCase().includes(this.searchTerm.toLowerCase())
                        );
                    }

                    // Sort files
                    filtered.sort((a, b) => {
                        let aVal = a[this.sortBy];
                        let bVal = b[this.sortBy];
                        
                        if (this.sortBy === 'size') {
                            aVal = parseInt(aVal) || 0;
                            bVal = parseInt(bVal) || 0;
                        }
                        
                        if (aVal < bVal) return this.sortDesc ? 1 : -1;
                        if (aVal > bVal) return this.sortDesc ? -1 : 1;
                        return 0;
                    });

                    return filtered;
                },

                get paginatedFiles() {
                    const start = (this.currentPage - 1) * this.pageSize;
                    const end = start + this.pageSize;
                    return this.filteredFiles.slice(start, end);
                },

                get totalPages() {
                    return Math.ceil(this.filteredFiles.length / this.pageSize);
                },

                setSorting(column) {
                    if (this.sortBy === column) {
                        this.sortDesc = !this.sortDesc;
                    } else {
                        this.sortBy = column;
                        this.sortDesc = false;
                    }
                },

                toggleFileSelection(fileId) {
                    if (this.selectedFiles.has(fileId)) {
                        this.selectedFiles.delete(fileId);
                    } else {
                        this.selectedFiles.add(fileId);
                    }
                },

                selectAllFiles() {
                    this.paginatedFiles.forEach(file => {
                        this.selectedFiles.add(file.id);
                    });
                },

                clearSelection() {
                    this.selectedFiles.clear();
                },

                async deleteFile(fileId) {
                    if (!confirm('Are you sure you want to delete this file?')) {
                        return;
                    }

                    try {
                        await axios.delete(`/api/admin/files/${fileId}`);
                        await this.loadFiles();
                        this.selectedFiles.delete(fileId);
                    } catch (error) {
                        console.error('Failed to delete file:', error);
                        alert('Failed to delete file');
                    }
                },

                async deleteSelectedFiles() {
                    if (this.selectedFiles.size === 0) return;
                    
                    if (!confirm(`Are you sure you want to delete ${this.selectedFiles.size} selected files?`)) {
                        return;
                    }

                    try {
                        const deletePromises = Array.from(this.selectedFiles).map(fileId => 
                            axios.delete(`/api/admin/files/${fileId}`)
                        );
                        await Promise.all(deletePromises);
                        await this.loadFiles();
                        this.clearSelection();
                    } catch (error) {
                        console.error('Failed to delete files:', error);
                        alert('Failed to delete selected files');
                    }
                },

                async downloadFile(fileId, filename) {
                    try {
                        const response = await axios.get(`/api/admin/files/${fileId}/download`, {
                            responseType: 'blob'
                        });
                        
                        const url = window.URL.createObjectURL(new Blob([response.data]));
                        const link = document.createElement('a');
                        link.href = url;
                        link.setAttribute('download', filename);
                        document.body.appendChild(link);
                        link.click();
                        link.remove();
                        window.URL.revokeObjectURL(url);
                    } catch (error) {
                        console.error('Failed to download file:', error);
                        alert('Failed to download file');
                    }
                },

                getFileIcon(filename) {
                    const ext = filename.split('.').pop().toLowerCase();
                    const iconMap = {
                        'jmx': 'fas fa-cogs text-primary',
                        'jar': 'fas fa-file-archive text-warning',
                        'csv': 'fas fa-file-csv text-success',
                        'txt': 'fas fa-file-alt text-info',
                        'properties': 'fas fa-file-code text-secondary'
                    };
                    return iconMap[ext] || 'fas fa-file text-muted';
                },

                formatFileSize(bytes) {
                    if (!bytes || bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                },

                formatDate(dateString) {
                    return dateString ? new Date(dateString).toLocaleDateString() : 'Unknown';
                }
            }
        }

        // Realtime System Component
        function realtimeSystemComponent() {
            return {
                systemMetrics: {
                    activeConnections: 0,
                    requestsPerSecond: 0,
                    responseTime: '0ms',
                    errorRate: '0%'
                },
                isConnected: false,
                lastUpdate: null,

                async init() {
                    await this.loadSystemMetrics();
                    this.setupRealTimeUpdates();
                },

                async loadSystemMetrics() {
                    try {
                        // For now, use mock data since detailed metrics endpoint doesn't exist
                        // In production, this would connect to actual monitoring systems
                        this.systemMetrics = {
                            activeConnections: Math.floor(Math.random() * 100) + 50,
                            requestsPerSecond: Math.floor(Math.random() * 50) + 10,
                            responseTime: Math.floor(Math.random() * 100) + 50 + 'ms',
                            errorRate: (Math.random() * 5).toFixed(2) + '%'
                        };
                        this.lastUpdate = new Date();
                        this.isConnected = true;
                    } catch (error) {
                        console.error('Failed to load system metrics:', error);
                        this.isConnected = false;
                    }
                },

                setupRealTimeUpdates() {
                    // Update every 5 seconds
                    setInterval(() => {
                        this.loadSystemMetrics();
                    }, 5000);
                },

                formatTime(timestamp) {
                    return timestamp ? new Date(timestamp).toLocaleTimeString() : 'Never';
                }
            }
        }

        // Admin Dashboard Component
        function adminDashboard() {
            return {
                stats: {
                    totalUsers: 0,
                    activeCollections: 0,
                    totalProjects: 0,
                    totalPlans: 0,
                    systemLoad: '0%'
                },
                recentActivity: [],
                systemHealth: {
                    cpu: 0,
                    memory: 0,
                    disk: 0
                },
                systemStatus: { isOnline: true },

                async init() {
                    console.log('Admin dashboard initializing...');
                    await this.loadStats();
                    await this.loadRecentActivity();
                    await this.loadSystemHealth();
                    
                    // Update parent component's system status
                    this.$parent.systemStatus = this.systemStatus;
                    
                    // Set up real-time updates every 30 seconds
                    setInterval(() => this.loadSystemHealth(), 30000);
                    setInterval(() => this.loadStats(), 60000); // Update stats every minute
                },

                async loadStats() {
                    try {
                        console.log('Loading admin stats...');
                        
                        // Load stats from the admin stats endpoint
                        const statsResponse = await axios.get('/api/admin/stats');
                        if (statsResponse.data) {
                            this.stats.totalProjects = statsResponse.data.totalProjects || 0;
                            this.stats.activeCollections = statsResponse.data.activeCollections || 0;
                            this.stats.totalUsers = statsResponse.data.totalUsers || 0;
                            this.stats.totalPlans = statsResponse.data.totalPlans || 0;
                            this.stats.systemLoad = statsResponse.data.systemLoad || '0%';
                        }
                        
                        console.log('Admin stats loaded:', this.stats);
                        
                    } catch (error) {
                        console.error('Failed to load admin stats:', error);
                        
                        // Check if it's an authentication error
                        if (error.response && error.response.status === 403) {
                            console.log('User does not have admin permissions');
                            // Show a message or redirect to login
                            if (error.response.data && error.response.data.message && error.response.data.message.includes('login')) {
                                window.location.href = '/login';
                                return;
                            }
                        }
                        
                        // Try to load some basic stats that don't require admin permissions
                        try {
                            const projectsResponse = await axios.get('/api/projects');
                            if (projectsResponse.data) {
                                this.stats.totalProjects = projectsResponse.data.length || 0;
                                
                                // Count total plans across all projects
                                let totalPlans = 0;
                                projectsResponse.data.forEach(project => {
                                    if (project.plans) {
                                        totalPlans += project.plans.length;
                                    }
                                });
                                this.stats.totalPlans = totalPlans;
                            }
                        } catch (fallbackError) {
                            console.log('Could not load fallback stats:', fallbackError);
                        }
                        
                        this.systemStatus.isOnline = false;
                        this.$parent.systemStatus = this.systemStatus;
                    }
                },

                async loadRecentActivity() {
                    try {
                        // Try to load real activity, fallback to mock data
                        try {
                            const response = await axios.get('/api/admin/activity');
                            this.recentActivity = response.data.activities || [];
                        } catch (error) {
                            // Fallback to mock recent activity
                            this.recentActivity = [
                                {
                                    id: 1,
                                    user: 'admin',
                                    action: 'Created new project',
                                    details: 'Load Test Project Alpha',
                                    timestamp: new Date(Date.now() - 300000) // 5 minutes ago
                                },
                                {
                                    id: 2,
                                    user: 'manager',
                                    action: 'Started collection',
                                    details: 'Performance Test Collection',
                                    timestamp: new Date(Date.now() - 900000) // 15 minutes ago
                                },
                                {
                                    id: 3,
                                    user: 'tester',
                                    action: 'Uploaded test plan',
                                    details: 'API_Load_Test.jmx',
                                    timestamp: new Date(Date.now() - 1800000) // 30 minutes ago
                                }
                            ];
                        }
                    } catch (error) {
                        console.error('Failed to load recent activity:', error);
                        this.recentActivity = [];
                    }
                },

                async loadSystemHealth() {
                    try {
                        const response = await axios.get('/api/admin/health');
                        if (response.data) {
                            // Convert percentage strings to numbers for display
                            this.systemHealth = {
                                cpu: parseInt(response.data.cpu) || 0,
                                memory: parseInt(response.data.memory) || 0,
                                disk: parseInt(response.data.disk) || 0
                            };
                            this.systemStatus.isOnline = true;
                            this.$parent.systemStatus = this.systemStatus;
                        }
                    } catch (error) {
                        console.error('Failed to load system health:', error);
                        // Fallback to mock data
                        this.systemHealth = {
                            cpu: Math.floor(Math.random() * 80) + 10,
                            memory: Math.floor(Math.random() * 70) + 20,
                            disk: Math.floor(Math.random() * 60) + 15
                        };
                        this.systemStatus.isOnline = false;
                        this.$parent.systemStatus = this.systemStatus;
                    }
                },

                formatTime(timestamp) {
                    return timestamp ? new Date(timestamp).toLocaleString() : 'Never';
                }
            }
        }
    </script>
</body>
</html>